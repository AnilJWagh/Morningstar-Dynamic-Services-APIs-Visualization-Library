import { Canvas, Meta, Story, ArgsTable } from "@storybook/addon-docs";
import ProductInvolvement from "@/components/product-involvement/ProductInvolvement.vue";
import { PORTFOLIO_ANALYSIS_AMERICAS_URL, DATA_ACCESS_LIBRARY } from "@/external-links";

<Meta title="ProductInvolvement" component={ProductInvolvement} />

<style> {
  `
    details {
      padding: 10px;
      font-weight: bold;
      color: white;
      background: #3c3c3c;
    }
    summary {
      font-family: "Nunito Sans","San Francisco",BlinkMacSystemFont,"Segoe UI","Helvetica Neue",Helvetica,Arial,sans-serif;
      cursor: pointer;
    }
    .summary-text {
      padding-left: 5px;
      font-size: 15px;
    }
    .v-application--wrap {
        min-height: 100%
    }
  `}

</style>

# Product Involvement

- [Description US](#description)
- [Properties](#properties)
- [Fetching Data](#fetching-data)
- [Data Transformation](#data-transformation)


## Description

The Product Involvement component displays metrics that illustrate a portfolioâ€™s exposure to various products, services, and business activities on a percentage involvement basis.

<Canvas withSource="open" withToolbar>
  <Story id="components-product-involvement--async-story-details"></Story>
</Canvas>

## Properties

<ArgsTable of={ ProductInvolvement } />

## Fetching Data

The component is populated with data returned by calls to the <a href={PORTFOLIO_ANALYSIS_AMERICAS_URL} target="_blank">Portfolio Analysis API (Americas)</a>.
<!--
- [API Data Access Library](#api-data-access-library)
- [Request Example](#request)
- [Request Payload Example](#request-payload)
-->
### API Data Access Library

The <a href={DATA_ACCESS_LIBRARY} target="_blank">API Data Access Library</a> is used to fetch data from the API.
Request header 'prefer: 'respond-async' allows to fetch the response asynchronously, which makes sure the response is
available without timeout issues

``` javascript dark
window.mstarApisSdk.portfolioAnalysis.getProductInvolvementData({
    portfolios: samplePortfolio,
    languageId: 'en-US',
    prefer: 'respond-async'
});
```
<details>
  <summary><span class="summary-text">Example</span></summary>

``` javascript dark
const samplePortfolio = [
    {
        Name: 'Test Portfolio1',
        TotalValue: 10000,
        Holdings: [
            {
                SecurityId: 'F00000VPDY',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000VPDZ',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000VPE0',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000WK3S',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000WK3Q',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000WK3R',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000T76W',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000T76Y',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000T76Z',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000T76X',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000T770',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000T772',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000T773',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000T771',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000VPDQ',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000VPDR',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000VPDS',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000WK3Z',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000WK42',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000WK47',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000WK4B',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000WK4F',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000WK4J',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000WK4N',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000WK4R',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000WK3V',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000T777',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000T775',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000T776',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000T774',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F000011DGV',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F000011DGU',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000H35Y',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000H35X',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000H35W',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000J8SX',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000PQ2U',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'FOUSA007RP',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'FOUSA00ABD',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'FOUSA05GYK',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'FOUSA00DEK',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'FOUSA08N2L',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'FOUSA00KJW',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'FOUSA00COA',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'FOUSA00CTW',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'FOUSA05HX7',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000WRW6',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000WRW5',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000WRW7',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000UEIB',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000UEIA',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000UEIC',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000QSIZ',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000QSIX',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000N79H',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000N75J',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000UDFO',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000N1IS',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000XKG7',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000XKG8',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000OEUB',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000OEUC',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000OEUA',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000ZKDA',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000ZKD9',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000ZKKG',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000T6OZ',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000T6P0',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000T6P1',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000PEIU',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000PEIV',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000PEIW',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000ZF1O',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F000010IS3',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'FOUSA05KKV',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000YSY7',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000YSY8',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000WQUJ',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F000010GIB',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F000010GIA',
                Type: 'FO',
                Value: 100,
            },
            {
                SecurityId: 'F00000U3B0',
                Type: 'FO',
                Value: 100,
            },
        ],
        Benchmark: {
            Type: 'Standard',
            Holdings: [
                {
                    SecurityId: 'XIUSA0010V',
                    Type: 'XI',
                    Weight: 100,
                },
            ],
        },
    },
];

window.mstarApisSdk.portfolioAnalysis.getProductInvolvementData({
    portfolios: samplePortfolio,
    languageId: 'en-US',
    headers: {
        prefer: 'respond-async',
    },
});

```
</details>
&nbsp;

### Request Example

```javascript dark
"https://www.us-api.morningstar.com/portfolio-analysis/v1/sustainability/product-involvement?langcult={{languageId}}"

```
### Request Payload Example

Asynchronous API Requests has below 3 steps to get the ESG data Response:
1. **Initiating Request**: Product Involvement Sustainability API will send back the jobId as shown in the below example. To make the request asynchronous
   we need to pass the â€˜preferâ€™ header in the request as shown in the example below.

    ```javascript dark
        https://www.us-api.morningstar.com/portfolio-analysis/v1/sustainability/product-involvement?langcult={{languageId}}
    ```

    #### Request Payload Example
    | Query Parameter | Description | Example |
    | :-------------- | :---------- | :------ |
    | `languageId` | ISO culture codes. If not provided, defaults to the language defined in settings. | `languageId=en-US` |

    | Request Header | Description | Example |
    | :------------- | :---------- | :------ |
    | `prefer` | Get the response in asynchronous format | `prefer=respond-async` |

    #### Sample JobId API Response Data Format

    ```javascript dark
    {
      "jobId": "efb3a071-cd29-41c6-86ce-fb1b3569b5e4",
      "_links": [
          {
              "href": "www.us-api.morningstar.com/dynamic-services-apis/jobs/efb3a071-cd29-41c6-86ce-fb1b3569b5e4",
              "rel": "self",
              "method": "GET"
          }
      ]
    }
    ```
2. **Pooling Status**: Once JobId is received, use below API to get the status from the S3 server in the below format.

    ```javascript dark
        https://www.us-api.morningstar.com/portfolio-analysis/dynamic-services-apis/jobs/:jobId
    ```
    When the *Automatically follow redirects* setting is on(itâ€™s true by default in postman as well as in all native browsers)
    then it automatically redirects to step 3 and returns the response with the status code 200 when the response is available.
    Otherwise, we need to keep polling the API until we get a final response.

    #### Sample response for the pending status.

    ```javascript dark
    {
        "id": "8d616381-9be9-4a2e-85ec-3f5bf244e7c8",
        "created": "2023-05-11T10:12:08.3246921Z",
        "status": "pending",
        "isComplete": false,
        "_links": [
            {
                "href": "https://www.us-api.morningstar.com/jobs/8d616381-9be9-4a2e-85ec-3f5bf244e7c8",
                "rel": "self",
                "method": "GET"
            }
        ]
    }
    ```
    When the *Automatically follow redirects* setting is off then it returns the status code '302 Found' and the URL
    provided will be returned in the response header. Follow Step 3 to get final response.

3. **Getting Final Response**: Make the Get request to fetch final response from S3 server.

    ```javascript dark
        https://www.us-api.morningstar.com/portfolio-analysis/v1/sustainability/:requestId
    ```
    *Note: RequestId in below URl is received in the step 2 APIs 'location' response header*


## Data Transformation

Data returned by the API must be transformed to a format the component understands.
<!--
- [API Response Data Format](#api-response-data-format)
- [Integration Data Format](#integration-data-format)
- [Integration Transformation Operation](#integration-transformation-operation)
- [Component Transformed Data Format](#component-transformed-data-format)
- [Component Transformation Operation](#component-transformation-operation)
-->

### API Response Data Format
<details>
  <summary><span class="summary-text">Code Snippet</span></summary>

```json dark
{
    "sustainability": [
        {
            "portfolio": {
                "name": "Test Portfolio1",
                "productInvolvement": {
                    "date": "2023-01-31",
                    "abortiveContraceptivesStemCell": 8.625899,
                    "adultEntertainment": 0,
                    "alcohol": 0,
                    "animalTesting": 12.112276,
                    "controversialWeapons": 0,
                    "furAndSpecialtyLeather": 0,
                    "gambling": 0,
                    "gmo": 0,
                    "militaryContracting": 3.7213857,
                    "nuclear": 4.837718,
                    "palmOil": 0,
                    "pesticides": 0,
                    "smallArms": 0,
                    "thermalCoal": 3.3160741,
                    "tobacco": 0
                }
            },
            "benchmark": {
                "name": "Morningstar US Market TR USD",
                "identifier": "XIUSA0010V",
                "identifierType": "SecurityId",
                "securityType": "XI",
                "productInvolvement": {
                    "abortiveContraceptivesStemCell": 10.45828,
                    "adultEntertainment": 0,
                    "alcohol": 0.18794,
                    "animalTesting": 21.60459,
                    "controversialWeapons": 2.07183,
                    "furAndSpecialtyLeather": 0,
                    "gambling": 0.3169,
                    "gmo": 0.11377,
                    "militaryContracting": 3.48873,
                    "nuclear": 2.127,
                    "palmOil": 0,
                    "pesticides": 0.17732,
                    "smallArms": 1.06037,
                    "thermalCoal": 1.44929,
                    "tobacco": 0.6942
                }
            },
            "securityBreakdown": [
                {
                    "name": "London & Capital Glbl Bal Fxd Inc I Â£Inc",
                    "identifier": "0P00013NQG",
                    "identifierType": "PerformanceId",
                    "securityType": "FO",
                    "productInvolvement": {
                        "abortiveContraceptivesStemCell": 8.40239,
                        "adultEntertainment": 0,
                        "alcohol": 0,
                        "animalTesting": 11.60398,
                        "controversialWeapons": 0,
                        "furAndSpecialtyLeather": 0,
                        "gambling": 0,
                        "gmo": 0,
                        "militaryContracting": 3.59007,
                        "nuclear": 4.54035,
                        "palmOil": 0,
                        "pesticides": 0,
                        "smallArms": 0,
                        "thermalCoal": 3.12427,
                        "tobacco": 0
                    }
                }
            ],
            "metadata": {
                "messages": [
                    {
                        "type": "Warning",
                        "message": "Invalid or unentitled holdings",
                        "invalidHoldings": [
                            {
                                "securityId": "F0GBR052QA",
                                "status": "Unentitled"
                            },
                            {
                                "securityId": "F000000EY1",
                                "status": "Unentitled"
                            },
                            {
                                "securityId": "F00000OXG7",
                                "status": "Unentitled"
                            }
                        ]
                    }
                ]
            }
        }
    ],
    "metadata": {
        "requestId": "9eeb7465-e774-45d8-905c-358ec272f804"
    }
}
```
</details>
&nbsp;

### Integration Data Format
<details>
  <summary><span class="summary-text">Code Snippet</span></summary>

```json dark
{
    "portfolio": {
        "abortiveContraceptivesStemcell": 6.6914544,
        "animalTesting": 12.180668,
        "controversialWeapons": 1.2591741,
        "adultEntertainment": 0,
        "alcohol": 1.1270572,
        "furAndSpecialtyLeather": 0,
        "gambling": 0.28550306,
        "militaryContracting": 2.0566392,
        "nuclear": 0.43815938,
        "palmOil": 0.008738188,
        "pesticides": 0.06944976,
        "smallArms": 1.3401275,
        "thermalCoal": 0.12252558,
        "tobacco": 0.16017261,
        "gmo": 0.017991528
    },
    "benchmark": {
        "abortiveContraceptivesStemcell": 9.76653,
        "animalTesting": 20.19085,
        "controversialWeapons": 1.88323,
        "adultEntertainment": 0,
        "alcohol": 0.15723,
        "furAndSpecialtyLeather": 0,
        "gambling": 0.15979,
        "militaryContracting": 3.08397,
        "nuclear": 1.94728,
        "palmOil": 0,
        "pesticides": 0.15281,
        "smallArms": 0.98947,
        "thermalCoal": 1.36642,
        "tobacco": 0.62949,
        "gmo": 0.10922
    }
}
```
</details>
&nbsp;

### Integration Transformation Operation
<details>
  <summary><span class="summary-text">Code Snippet</span></summary>

```javascript dark
function getProductInvolvementData(esgData) {
    return getComponentData(
        esgData,
        'portfolio.productInvolvement',
        'benchmark.productInvolvement',
    );
}
```
</details>
&nbsp;

### Component Transformed Data Format
<details>
  <summary><span class="summary-text">Code Snippet</span></summary>

```json dark
        [
        {
            "name": "businessPractices"
        },
        {
            "name": "animalTesting",
            "portfolio": "11.99",
            "benchmark": "20.19"
        },
        {
            "name": "furAndSpecialtyLeather",
            "portfolio": "0.00",
            "benchmark": "0.00"
        },
        {
            "name": "defenseAndMilitary"
        },
        {
            "name": "controversialWeapons",
            "portfolio": "0.86",
            "benchmark": "1.88"
        },
        {
            "name": "militaryContracting",
            "portfolio": "1.55",
            "benchmark": "3.08"
        },
        {
            "name": "smallArms",
            "portfolio": "0.95",
            "benchmark": "0.99"
        },
        {
            "name": "energy"
        },
        {
            "name": "nuclear",
            "portfolio": "0.43",
            "benchmark": "1.95"
        },
        {
            "name": "thermalCoal",
            "portfolio": "0.10",
            "benchmark": "1.37"
        },
        {
            "name": "environment"
        },
        {
            "name": "gmo",
            "portfolio": "0.01",
            "benchmark": "0.11"
        },
        {
            "name": "palmOil",
            "portfolio": "0.01",
            "benchmark": "0.00"
        },
        {
            "name": "pesticides",
            "portfolio": "0.04",
            "benchmark": "0.15"
        },
        {
            "name": "healthAndLife"
        },
        {
            "name": "alcohol",
            "portfolio": "0.95",
            "benchmark": "0.16"
        },
        {
            "name": "lifeEthics"
        },
        {
            "name": "tobacco",
            "portfolio": "0.14",
            "benchmark": "0.63"
        },
        {
            "name": "valuesBased"
        },
        {
            "name": "adultEntertainment",
            "portfolio": "0.00",
            "benchmark": "0.00"
        },
        {
            "name": "gambling",
            "portfolio": "0.25",
            "benchmark": "0.16"
        }
    ]
```
</details>
&nbsp;

### Component Transformation Operation
<details>
  <summary><span class="summary-text">Code Snippet</span></summary>

```javascript dark
    parsedModelData() {
        if (this.modelData) {
            const parseProductInvolvementData = [];
            const { valueMapping } = productInvolvementMapping;
            const productInvolvementData = this.modelData;

            if (productInvolvementData.portfolio || productInvolvementData.benchmark) {
                valueMapping.dataPoints.forEach((key) => {
                    parseProductInvolvementData.push({
                        name: key,
                    });
                    valueMapping.dataPointsObject[key].forEach((item) => {
                        if (item) {
                            parseProductInvolvementData.push({
                                name: item,
                                portfolio: productInvolvementData?.portfolio[item]?.toFixed(2) ?? '-',
                                benchmark: productInvolvementData?.benchmark[item]?.toFixed(2) ?? '-',
                            });
                        }
                    });
                });
                return parseProductInvolvementData;
            }
        }
        return [];
    }
```
</details>
